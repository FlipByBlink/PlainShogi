import Foundation

//             ç‰
// 00,01,02,03,04,05,06,07,08
// 09,10,11,12,13,14,15,16,17
// ...
// 63,64,65,66,67,68,69,70,71
// 72,73,74,75,76,77,78,79,80
//             ç‹

struct å±€é¢ãƒ¢ãƒ‡ãƒ«: Codable {
    private(set) var ç›¤é§’: [Int: ç›¤ä¸Šã®é§’]
    private(set) var æ‰‹é§’: [ç‹å´ã‹ç‰å´ã‹: æŒã¡é§’]
    private(set) var ç›´è¿‘ã®æ“ä½œ: æ“ä½œçµæœã¨ã—ã¦å¼·èª¿ã™ã‚‹å¯¾è±¡ = .ãªã—
    private(set) var æ›´æ–°æ—¥æ™‚: Date?
    
    mutating func ç›¤é§’ã‚’ç§»å‹•ã•ã›ã‚‹(_ å‡ºç™ºåœ°ç‚¹: Int, _ ç½®ã„ãŸä½ç½®: Int) throws {
        if ç½®ã„ãŸä½ç½® == å‡ºç™ºåœ°ç‚¹ { throw ğŸš¨é§’ç§»å‹•ã‚¨ãƒ©ãƒ¼.ç„¡åŠ¹ }
        guard let å‹•ã‹ã—ãŸé§’ = self.ç›¤é§’[å‡ºç™ºåœ°ç‚¹] else { throw ğŸš¨ã‚¨ãƒ©ãƒ¼.è¦ä¿®æ­£ }
        if let å…ˆå®¢ = self.ç›¤é§’[ç½®ã„ãŸä½ç½®] {
            if å…ˆå®¢.é™£å–¶ == å‹•ã‹ã—ãŸé§’.é™£å–¶ { throw ğŸš¨é§’ç§»å‹•ã‚¨ãƒ©ãƒ¼.ç„¡åŠ¹ }
            self.æ‰‹é§’[å‹•ã‹ã—ãŸé§’.é™£å–¶]?.ä¸€å€‹å¢—ã‚„ã™(å…ˆå®¢.è·å)
        }
        self.ç›¤é§’.removeValue(forKey: å‡ºç™ºåœ°ç‚¹)
        self.ç›¤é§’.updateValue(å‹•ã‹ã—ãŸé§’, forKey: ç½®ã„ãŸä½ç½®)
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .ç›¤é§’(ç½®ã„ãŸä½ç½®))
    }
    
    mutating func æ‰‹é§’ã‚’ç›¤ä¸Šã¸ç§»å‹•ã•ã›ã‚‹(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡, _ ç½®ã„ãŸä½ç½®: Int) throws {
        if self.ç›¤é§’[ç½®ã„ãŸä½ç½®] != nil { throw ğŸš¨é§’ç§»å‹•ã‚¨ãƒ©ãƒ¼.ç„¡åŠ¹ }
        self.ç›¤é§’.updateValue(ç›¤ä¸Šã®é§’(é™£å–¶, è·å), forKey: ç½®ã„ãŸä½ç½®)
        self.æ‰‹é§’[é™£å–¶]?.ä¸€å€‹æ¸›ã‚‰ã™(è·å)
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .ç›¤é§’(ç½®ã„ãŸä½ç½®))
    }
    
    mutating func ç›¤é§’ã‚’ç›¤å¤–ã¸ç§»å‹•ã•ã›ã‚‹(_ å‡ºç™ºåœ°ç‚¹: Int, _ ç§»å‹•å…ˆã®é™£å–¶: ç‹å´ã‹ç‰å´ã‹) throws {
        guard let å‹•ã‹ã—ãŸé§’ = self.ç›¤é§’[å‡ºç™ºåœ°ç‚¹] else { throw ğŸš¨ã‚¨ãƒ©ãƒ¼.è¦ä¿®æ­£ }
        self.ç›¤é§’.removeValue(forKey: å‡ºç™ºåœ°ç‚¹)
        self.æ‰‹é§’[ç§»å‹•å…ˆã®é™£å–¶]?.ä¸€å€‹å¢—ã‚„ã™(å‹•ã‹ã—ãŸé§’.è·å)
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .æ‰‹é§’(ç§»å‹•å…ˆã®é™£å–¶, å‹•ã‹ã—ãŸé§’.è·å))
    }
    
    mutating func è‡ªåˆ†ã®æ‰‹é§’ã‚’æ•µã®æ‰‹é§’å´ã«ç§»å‹•ã•ã›ã‚‹(_ ç§»å‹•å…ƒã®é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡, _ ç§»å‹•å…ˆã®é™£å–¶: ç‹å´ã‹ç‰å´ã‹) {
        self.æ‰‹é§’[ç§»å‹•å…ƒã®é™£å–¶]?.ä¸€å€‹æ¸›ã‚‰ã™(è·å)
        self.æ‰‹é§’[ç§»å‹•å…ˆã®é™£å–¶]?.ä¸€å€‹å¢—ã‚„ã™(è·å)
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .æ‰‹é§’(ç§»å‹•å…ˆã®é™£å–¶, è·å))
    }
    
    enum ğŸš¨é§’ç§»å‹•ã‚¨ãƒ©ãƒ¼: Error {
        case ç„¡åŠ¹
    }
    
    func ç›¤ä¸Šã®ã“ã®é§’ã®è¡¨è¨˜(_ ä½ç½®: Int, _ Englishè¡¨è¨˜: Bool) -> String? {
        guard let é§’ = self.ç›¤é§’[ä½ç½®] else { return nil }
        if Englishè¡¨è¨˜ {
            return é§’.æˆã‚Š ? é§’.è·å.Englishæˆé§’è¡¨è¨˜ : é§’.è·å.Englishç”Ÿé§’è¡¨è¨˜
        } else {
            if (é§’.é™£å–¶ == .ç‰å´) && (é§’.è·å == .ç‹) {
                return "ç‰"
            } else {
                return é§’.æˆã‚Š ? é§’.è·å.æˆé§’è¡¨è¨˜ : é§’.è·å.rawValue
            }
        }
    }
    
    func ã“ã®æ‰‹é§’ã®è¡¨è¨˜(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡, _ Englishè¡¨è¨˜: Bool) -> String {
        if !Englishè¡¨è¨˜ && (é™£å–¶ == .ç‰å´) && (è·å == .ç‹) {
            return "ç‰"
        } else {
            return Englishè¡¨è¨˜ ? è·å.Englishç”Ÿé§’è¡¨è¨˜ : è·å.rawValue
        }
    }
    
    func ã“ã®æ‰‹é§’ã®æ•°(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡) -> Int {
        self.æ‰‹é§’[é™£å–¶]?.å€‹æ•°(è·å) ?? 0
    }
    
    func ã“ã®é§’ã®æˆã‚Šã«ã¤ã„ã¦åˆ¤æ–­ã™ã¹ã(_ ç§»å‹•å…ˆ: Int, _ å…ƒã€…ã®ä½ç½®: Int?) -> Bool {
        guard let å…ƒã€…ã®ä½ç½® else { return false }
        if let ç§»å‹•å¾Œã®é§’ = self.ç›¤é§’[ç§»å‹•å…ˆ] {
            if ç§»å‹•å¾Œã®é§’.æˆã‚Š == false {
                if ç§»å‹•å¾Œã®é§’.è·å.æˆé§’ã‚ã‚Š {
                    switch ç§»å‹•å¾Œã®é§’.é™£å–¶ {
                        case .ç‹å´:
                            if ç§»å‹•å…ˆ < 27 { return true }
                            if å…ƒã€…ã®ä½ç½® < 27 { return true }
                        case .ç‰å´:
                            if 53 < ç§»å‹•å…ˆ { return true }
                            if 53 < å…ƒã€…ã®ä½ç½® { return true }
                    }
                }
            }
        }
        return false
    }
    
    mutating func ã“ã®é§’ã‚’è£è¿”ã™(_ ä½ç½®: Int) {
        if self.ç›¤é§’[ä½ç½®]?.è·å.æˆé§’ã‚ã‚Š == true {
            self.ç›¤é§’[ä½ç½®]?.è£è¿”ã™()
            self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .ç›¤é§’(ä½ç½®))
        }
    }
    
    mutating func ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’ä¸€å€‹å¢—ã‚„ã™(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡) {
        self.æ‰‹é§’[é™£å–¶]?.ä¸€å€‹å¢—ã‚„ã™(è·å)
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .æ‰‹é§’(é™£å–¶, è·å))
    }
    
    mutating func ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’ä¸€å€‹æ¸›ã‚‰ã™(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡) {
        if self.ã“ã®æ‰‹é§’ã®æ•°(é™£å–¶, è·å) >= 0 {
            self.æ‰‹é§’[é™£å–¶]?.ä¸€å€‹æ¸›ã‚‰ã™(è·å)
            self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .æ‰‹é§’(é™£å–¶, è·å))
        }
    }
    
    mutating func ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®ç›¤é§’ã‚’æ¶ˆã™(_ ä½ç½®: Int) {
        self.ç›¤é§’.removeValue(forKey: ä½ç½®)
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .ç›¤é§’(ä½ç½®))
    }
    
    mutating func ç›´è¿‘æ“ä½œæƒ…å ±ã‚’æ¶ˆã™() {
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .ãªã—)
    }
    
    mutating func åˆæœŸåŒ–ã™ã‚‹() {
        self = .åˆæœŸã‚»ãƒƒãƒˆ
        self.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: .ãªã—)
    }
    
    private mutating func ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã®é›‘å¤šå‡¦ç†(å¼·èª¿å¯¾è±¡: æ“ä½œçµæœã¨ã—ã¦å¼·èª¿ã™ã‚‹å¯¾è±¡) {
        self.ç›´è¿‘ã®æ“ä½œ = å¼·èª¿å¯¾è±¡
        self.æ›´æ–°æ—¥æ™‚ = .now
        self.ç¾åœ¨ã®å±€é¢ã‚’å±¥æ­´ã«è¿½åŠ ã™ã‚‹()
    }
    
    //SharePlayãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Šæ™‚
    mutating func æ›´æ–°æ—¥æ™‚ã‚’å¤‰æ›´ã›ãšã«ãƒ¢ãƒ‡ãƒ«ã‚’é©ç”¨ã™ã‚‹(_ æ–°è¦å±€é¢: Self) {
        self = æ–°è¦å±€é¢
        self.ç¾åœ¨ã®å±€é¢ã‚’å±¥æ­´ã«è¿½åŠ ã™ã‚‹()
    }
    
    //å±¥æ­´å¾©å…ƒã‚„ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿é©ç”¨
    mutating func ç¾åœ¨ã®å±€é¢ã¨ã—ã¦é©ç”¨ã™ã‚‹(_ æ–°è¦å±€é¢: Self) {
        self = æ–°è¦å±€é¢
        self.æ›´æ–°æ—¥æ™‚ = .now
        self.ç¾åœ¨ã®å±€é¢ã‚’å±¥æ­´ã«è¿½åŠ ã™ã‚‹()
    }
    
    private func ç¾åœ¨ã®å±€é¢ã‚’å±¥æ­´ã«è¿½åŠ ã™ã‚‹() {
        do {
            let â“”ncoder = JSONEncoder()
            var æ–°ã—ã„å±¥æ­´: [Self]
            æ–°ã—ã„å±¥æ­´ = Self.å±¥æ­´
            if æ–°ã—ã„å±¥æ­´.count > 30 { æ–°ã—ã„å±¥æ­´.removeFirst() }
            æ–°ã—ã„å±¥æ­´ += [self]
            let â““ata = try â“”ncoder.encode(æ–°ã—ã„å±¥æ­´)
            UserDefaults.standard.set(â““ata, forKey: "å±¥æ­´")
        } catch {
            print("ğŸš¨", error.localizedDescription)
        }
    }
    
    static var å±¥æ­´: [Self] {
        if let â““ata = UserDefaults.standard.data(forKey: "å±¥æ­´") {
            do {
                let â““ecoder = JSONDecoder()
                return try â““ecoder.decode([Self].self, from: â““ata)
            } catch {
                print("ğŸš¨", error.localizedDescription)
                return []
            }
        } else {
            return []
        }
    }
    
    static func å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã™ã‚‹() {
        UserDefaults.standard.removeObject(forKey: "å±¥æ­´")
    }
    
    static var åˆæœŸã‚»ãƒƒãƒˆ: Self {
        Self(ç›¤é§’: åˆæœŸé…ç½®, æ‰‹é§’: ç©ºã®æ‰‹é§’)
    }
    
    enum æ“ä½œçµæœã¨ã—ã¦å¼·èª¿ã™ã‚‹å¯¾è±¡: Codable, Equatable {
        case ç›¤é§’(_ ä½ç½®: Int)
        case æ‰‹é§’(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡)
        case ãªã—
    }
}

enum ç‹å´ã‹ç‰å´ã‹: String, CaseIterable, Codable {
    case ç‹å´
    case ç‰å´
}

struct ç›¤ä¸Šã®é§’: Codable {
    let é™£å–¶: ç‹å´ã‹ç‰å´ã‹
    let è·å: é§’ã®ç¨®é¡
    var æˆã‚Š: Bool
    
    mutating func è£è¿”ã™() {
        if self.è·å.æˆé§’ã‚ã‚Š {
            self.æˆã‚Š.toggle()
        }
    }
    
    init(_ ï½¼ï¾ï¾ï½´ï½²: ç‹å´ã‹ç‰å´ã‹, _ ï½¼ï½®ï½¸ï¾’ï½²: é§’ã®ç¨®é¡, _ ï¾…ï¾˜: Bool = false) {
        (self.é™£å–¶, self.è·å, self.æˆã‚Š) = (ï½¼ï¾ï¾ï½´ï½², ï½¼ï½®ï½¸ï¾’ï½², ï¾…ï¾˜)
    }
}

struct æŒã¡é§’: Codable {
    var é…åˆ†: [é§’ã®ç¨®é¡: Int] = [:]
    
    func å€‹æ•°(_ è·å: é§’ã®ç¨®é¡) -> Int {
        self.é…åˆ†[è·å] ?? 0
    }
    
    static var ç©º: Self {
        Self(é…åˆ†: [:])
    }
    
    mutating func ä¸€å€‹å¢—ã‚„ã™(_ è·å: é§’ã®ç¨®é¡) {
        self.é…åˆ†[è·å] = self.å€‹æ•°(è·å) + 1
    }
    
    mutating func ä¸€å€‹æ¸›ã‚‰ã™(_ è·å: é§’ã®ç¨®é¡) {
        if self.å€‹æ•°(è·å) >= 1 {
            self.é…åˆ†[è·å] = self.å€‹æ•°(è·å) - 1
        }
    }
}

enum ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ {
    case ç›¤é§’(_ ä½ç½®: Int)
    case æ‰‹é§’(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡)
    case ã‚¢ãƒ—ãƒªå¤–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    case ç„¡ã—
}

enum é§’ã®ç¨®é¡: String, CaseIterable, Identifiable, Codable {
    case æ­©, è§’, é£›, é¦™, æ¡‚, éŠ€, é‡‘, ç‹
    
    var id: Self { self }
    
    func ç”Ÿé§’è¡¨è¨˜(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹) -> String {
        if é™£å–¶ == .ç‰å´ {
            if case .ç‹ = self {
                return "ç‰"
            }
        }
        return self.rawValue
    }
    
    var æˆé§’è¡¨è¨˜: String? {
        switch self {
            case .æ­©: return "ã¨"
            case .è§’: return "é¦¬"
            case .é£›: return "é¾"
            case .é¦™: return "æ"
            case .æ¡‚: return "åœ­"
            case .éŠ€: return "å…¨"
            default: return nil
        }
    }
    
    var æˆé§’ã‚ã‚Š: Bool {
        self.æˆé§’è¡¨è¨˜ != nil
    }
    
    var Englishç”Ÿé§’è¡¨è¨˜: String {
        switch self {
            case .æ­©: return "P"
            case .è§’: return "B"
            case .é£›: return "R"
            case .é¦™: return "L"
            case .æ¡‚: return "N"//è¦‹åˆ†ã‘ã‚‹ãŸã‚ã«ç›®å°ã‚’ä»˜ã‘ã‚‹å¿…è¦ã‚ã‚Š
            case .éŠ€: return "S"//è¦‹åˆ†ã‘ã‚‹ãŸã‚ã«ç›®å°ã‚’ä»˜ã‘ã‚‹å¿…è¦ã‚ã‚Š
            case .é‡‘: return "G"
            case .ç‹: return "K"
        }
    }
    
    var Englishæˆé§’è¡¨è¨˜: String? {
        switch self {
            case .æ­©: return "+P"
            case .è§’: return "+B"
            case .é£›: return "+R"
            case .é¦™: return "+L"
            case .æ¡‚: return "+N"
            case .éŠ€: return "+S"
            default: return nil
        }
    }
}




let ç©ºã®æ‰‹é§’: [ç‹å´ã‹ç‰å´ã‹: æŒã¡é§’] = [.ç‹å´: æŒã¡é§’.ç©º, .ç‰å´: æŒã¡é§’.ç©º]

let åˆæœŸé…ç½®: [Int: ç›¤ä¸Šã®é§’] = {
    var é…ç½®: [Int: ç›¤ä¸Šã®é§’] = [:]
    
    let ãƒ†ãƒ³ãƒ—ãƒ¬: [Int: (ç‹å´ã‹ç‰å´ã‹, é§’ã®ç¨®é¡)] =
    [00:(.ç‰å´,.é¦™),01:(.ç‰å´,.æ¡‚),02:(.ç‰å´,.éŠ€),03:(.ç‰å´,.é‡‘),04:(.ç‰å´,.ç‹),05:(.ç‰å´,.é‡‘),06:(.ç‰å´,.éŠ€),07:(.ç‰å´,.æ¡‚),08:(.ç‰å´,.é¦™),
                   10:(.ç‰å´,.é£›),                                                                     16:(.ç‰å´,.è§’),
     18:(.ç‰å´,.æ­©),19:(.ç‰å´,.æ­©),20:(.ç‰å´,.æ­©),21:(.ç‰å´,.æ­©),22:(.ç‰å´,.æ­©),23:(.ç‰å´,.æ­©),24:(.ç‰å´,.æ­©),25:(.ç‰å´,.æ­©),26:(.ç‰å´,.æ­©),
     
     54:(.ç‹å´,.æ­©),55:(.ç‹å´,.æ­©),56:(.ç‹å´,.æ­©),57:(.ç‹å´,.æ­©),58:(.ç‹å´,.æ­©),59:(.ç‹å´,.æ­©),60:(.ç‹å´,.æ­©),61:(.ç‹å´,.æ­©),62:(.ç‹å´,.æ­©),
                   64:(.ç‹å´,.è§’),                                                                     70:(.ç‹å´,.é£›),
     72:(.ç‹å´,.é¦™),73:(.ç‹å´,.æ¡‚),74:(.ç‹å´,.éŠ€),75:(.ç‹å´,.é‡‘),76:(.ç‹å´,.ç‹),77:(.ç‹å´,.é‡‘),78:(.ç‹å´,.éŠ€),79:(.ç‹å´,.æ¡‚),80:(.ç‹å´,.é¦™)]
    
    
    ãƒ†ãƒ³ãƒ—ãƒ¬.forEach { (ä½ç½®: Int, é§’: (é™£å–¶: ç‹å´ã‹ç‰å´ã‹, è·å: é§’ã®ç¨®é¡)) in
        é…ç½®[ä½ç½®] = ç›¤ä¸Šã®é§’(é§’.é™£å–¶, é§’.è·å)
    }
    
    return é…ç½®
}()
