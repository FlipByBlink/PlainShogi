import Combine
import SwiftUI
import UniformTypeIdentifiers
#if os(iOS)
import GroupActivities
#endif

@MainActor
class ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ«: ObservableObject {
    @Published private(set) var å±€é¢: å±€é¢ãƒ¢ãƒ‡ãƒ«
    
    @AppStorage("Englishè¡¨è¨˜") var englishè¡¨è¨˜: Bool = false
    @AppStorage("ç›´è¿‘æ“ä½œå¼·èª¿è¡¨ç¤ºæ©Ÿèƒ½ã‚ªãƒ•") var ç›´è¿‘æ“ä½œå¼·èª¿è¡¨ç¤ºæ©Ÿèƒ½ã‚ªãƒ•: Bool = false
    @AppStorage("ä¸Šä¸‹åè»¢") var ä¸Šä¸‹åè»¢: Bool = false
    
    @Published var è¡¨ç¤ºä¸­ã®ã‚·ãƒ¼ãƒˆ: ã‚·ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒª? = nil
    @Published var æˆé§’ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º: Bool = false
    @Published private(set) var å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ä¸­: Bool = false
    @Published private(set) var é¸æŠä¸­ã®é§’: é§’ã®å ´æ‰€ = .ãªã—
    
    init() {
        self.å±€é¢ = Self.èµ·å‹•æ™‚ã®å±€é¢ã‚’èª­ã¿è¾¼ã‚€()
        ICloudãƒ‡ãƒ¼ã‚¿.addObserver(self, #selector(self.iCloudã«ã‚ˆã‚‹å¤–éƒ¨ã‹ã‚‰ã®å±¥æ­´å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹(_:)))
        ICloudãƒ‡ãƒ¼ã‚¿.synchronize()
    }
    
#if os(iOS)
    // â†“ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£
    @Published private(set) var ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’: ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ = .ç„¡ã—
    // â†“ SharePlayé–¢é€£
    private var ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚º = Set<AnyCancellable>()
    private var ã‚¿ã‚¹ã‚¯ã‚¹ = Set<Task<Void, Never>>()
    @Published private(set) var ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³: GroupSession<ğŸ„¶roupActivity>?
    private var ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼: GroupSessionMessenger?
    @Published private(set) var å‚åŠ äººæ•°: Int?
#endif
}

//MARK: - ==== å±€é¢é–¢é€£ ====
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    func ã“ã®é§’ã®è¡¨è¨˜(_ å ´æ‰€: é§’ã®å ´æ‰€) -> String? {
        self.å±€é¢.ã“ã®é§’ã®è¡¨è¨˜(å ´æ‰€, self.englishè¡¨è¨˜)
    }
    func æ‰‹é§’å¢—æ¸›ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é§’ã®è¡¨è¨˜(_ è·å: é§’ã®ç¨®é¡, _ é™£å–¶: ç‹å´ã‹ç‰å´ã‹) -> String {
        self.englishè¡¨è¨˜ ? è·å.englishç”Ÿé§’è¡¨è¨˜ : è·å.ç”Ÿé§’è¡¨è¨˜(é™£å–¶)
    }
    func ã“ã®é§’ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨è¨˜(_ å ´æ‰€: é§’ã®å ´æ‰€) -> String? {
        self.å±€é¢.ã“ã®é§’ã®è·åè¡¨è¨˜(å ´æ‰€, self.englishè¡¨è¨˜)
    }
    func ã“ã®é§’ã¯æ“ä½œç›´å¾Œãªã®ã§å¼·èª¿è¡¨ç¤º(_ å ´æ‰€: é§’ã®å ´æ‰€) -> Bool {
        (self.å±€é¢.ç›´è¿‘ã®æ“ä½œ == å ´æ‰€) && !self.ç›´è¿‘æ“ä½œå¼·èª¿è¡¨ç¤ºæ©Ÿèƒ½ã‚ªãƒ•
    }
    func ã“ã®é§’ã«ã¯ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ãŒå¿…è¦(_ å ´æ‰€: é§’ã®å ´æ‰€) -> Bool {
        self.å±€é¢.ã“ã®é§’ã«ã¯ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ãŒå¿…è¦(å ´æ‰€, self.englishè¡¨è¨˜)
    }
    func ã“ã®é§’ã¯ä¸‹å‘ã(_ å ´æ‰€: é§’ã®å ´æ‰€) -> Bool {
        (self.å±€é¢.ã“ã®é§’ã®é™£å–¶(å ´æ‰€) == .ç‰å´) != self.ä¸Šä¸‹åè»¢
    }
    func ã“ã¡ã‚‰å´ã®ãƒœã‚¿ãƒ³ã¯ä¸‹å‘ã(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹) -> Bool {
        (é™£å–¶ == .ç‰å´) != self.ä¸Šä¸‹åè»¢
    }
    func ã“ã¡ã‚‰å´ã®é™£å–¶(_ ç«‹å ´: æ‰‹å‰ã‹å¯¾é¢ã‹) -> ç‹å´ã‹ç‰å´ã‹ {
        switch (ç«‹å ´, self.ä¸Šä¸‹åè»¢) {
            case (.æ‰‹å‰, false): .ç‹å´
            case (.å¯¾é¢, false): .ç‰å´
            case (.æ‰‹å‰, true): .ç‰å´
            case (.å¯¾é¢, true): .ç‹å´
        }
    }
    var ä½•ã‚‚å¼·èª¿è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„: Bool {
        self.å±€é¢.ç›´è¿‘ã®æ“ä½œ == .ãªã— && self.é¸æŠä¸­ã®é§’ == .ãªã—
    }
    var å¼·èª¿è¡¨ç¤ºå¸¸æ™‚ã‚ªãƒ•ã‹ã¤é§’ãŒé¸æŠã•ã‚Œã¦ã„ãªã„: Bool {
        self.ç›´è¿‘æ“ä½œå¼·èª¿è¡¨ç¤ºæ©Ÿèƒ½ã‚ªãƒ• && (self.é¸æŠä¸­ã®é§’ == .ãªã—)
    }
    func å¼·èª¿è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢() {
        withAnimation {
            self.å±€é¢.ç›´è¿‘æ“ä½œæƒ…å ±ã‚’æ¶ˆã™()
            self.é¸æŠä¸­ã®é§’ = .ãªã—
        }
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
    }
    func ã“ã®é§’ã‚’é¸æŠã™ã‚‹(_ ä»Šé¸æŠã—ãŸå ´æ‰€: é§’ã®å ´æ‰€) {
        if !self.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ä¸­ {
            switch self.é¸æŠä¸­ã®é§’ {
                case .ãªã—:
                    if self.å±€é¢.ã“ã“ã«é§’ãŒã‚ã‚‹(ä»Šé¸æŠã—ãŸå ´æ‰€) {
                        withAnimation(.default.speed(2.5)) {
                            self.é¸æŠä¸­ã®é§’ = ä»Šé¸æŠã—ãŸå ´æ‰€
                        }
                        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
                    }
                case .ç›¤é§’(let ä½ç½®) where self.é¸æŠä¸­ã®é§’ == ä»Šé¸æŠã—ãŸå ´æ‰€:
                    if self.å±€é¢.ã“ã®é§’ã¯æˆã‚‹äº‹ãŒã§ãã‚‹(ä½ç½®) {
                        self.ã“ã®é§’ã‚’è£è¿”ã™(ä½ç½®)
                    }
                    self.é¸æŠä¸­ã®é§’ = .ãªã—
                default:
                    if self.å±€é¢.ã“ã‚Œã¨ã“ã‚Œã¯åŒã˜é™£å–¶(self.é¸æŠä¸­ã®é§’, ä»Šé¸æŠã—ãŸå ´æ‰€) {
                        self.é¸æŠä¸­ã®é§’ = ä»Šé¸æŠã—ãŸå ´æ‰€
                        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
                    } else {
                        switch ä»Šé¸æŠã—ãŸå ´æ‰€ {
                            case .ç›¤é§’(let ä½ç½®):
                                if !self.å±€é¢.ã“ã“ã‹ã‚‰ã“ã“ã¸ã¯ç§»å‹•ä¸å¯(self.é¸æŠä¸­ã®é§’, .ç›¤ä¸Š(ä½ç½®)) {
                                    self.ç›¤ä¸Šã«é§’ã‚’ç§»å‹•ã•ã›ã‚‹(.ç›¤ä¸Š(ä½ç½®))
                                }
                            case .æ‰‹é§’(let é™£å–¶, _):
                                self.ã“ã¡ã‚‰ã®æ‰‹é§’ã‚¨ãƒªã‚¢ã‚’é¸æŠã™ã‚‹(é™£å–¶)
                            default:
                                break
                        }
                    }
            }
        } else {
            switch ä»Šé¸æŠã—ãŸå ´æ‰€ {
                case .ç›¤é§’(_):
                    self.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®ç›¤é§’ã‚’æ¶ˆã™(ä»Šé¸æŠã—ãŸå ´æ‰€)
                case .æ‰‹é§’(let é™£å–¶, _):
                    self.è¡¨ç¤ºä¸­ã®ã‚·ãƒ¼ãƒˆ = .æ‰‹é§’å¢—æ¸›(é™£å–¶)
                    ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
                default:
                    break
            }
        }
    }
    func ã“ã¡ã‚‰ã®æ‰‹é§’ã‚¨ãƒªã‚¢ã‚’é¸æŠã™ã‚‹(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹) {
        guard self.é¸æŠä¸­ã®é§’ != .ãªã— else { return }
        withAnimation(.default.speed(2)) {
            if self.å±€é¢.ã“ã“ã‹ã‚‰ã“ã“ã¸ã¯ç§»å‹•ä¸å¯(é¸æŠä¸­ã®é§’, .ç›¤å¤–(é™£å–¶)) {
                self.é¸æŠä¸­ã®é§’ = .ãªã—
                ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
            } else {
                do {
                    try self.å±€é¢.é§’ã‚’ç§»å‹•ã•ã›ã‚‹(é¸æŠä¸­ã®é§’, .ç›¤å¤–(é™£å–¶))
                    self.é¸æŠä¸­ã®é§’ = .ãªã—
                    self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
                    ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.å¼·ã‚()
                } catch {
                    assertionFailure()
                }
            }
        }
    }
    func ä»Šç§»å‹•ã—ãŸé§’ã‚’æˆã‚‹() {
        if case .ç›¤é§’(let ä½ç½®) = self.å±€é¢.ç›´è¿‘ã®æ“ä½œ {
            self.ã“ã®é§’ã‚’è£è¿”ã™(ä½ç½®)
        }
    }
    var æˆé§’ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: String {
        guard case .ç›¤é§’(let ä½ç½®) = self.å±€é¢.ç›´è¿‘ã®æ“ä½œ,
              let è·å = self.å±€é¢.ç›¤é§’[ä½ç½®]?.è·å else { return "âš ï¸" }
        if self.englishè¡¨è¨˜ {
            return è·å.englishç”Ÿé§’è¡¨è¨˜ + " â†’ " + (è·å.englishæˆé§’è¡¨è¨˜ ?? "âš ï¸")
        } else {
            return è·å.rawValue + " â†’ " + (è·å.æˆé§’è¡¨è¨˜ ?? "âš ï¸")
        }
    }
    func ç›¤é¢ã‚’åˆæœŸåŒ–ã™ã‚‹() {
        withAnimation { self.å±€é¢.åˆæœŸåŒ–ã™ã‚‹() }
        self.é¸æŠä¸­ã®é§’ = .ãªã—
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.ã‚¨ãƒ©ãƒ¼()
        self.è¡¨ç¤ºä¸­ã®ã‚·ãƒ¼ãƒˆ = nil
    }
    func é§’ã®é¸æŠã‚’è§£é™¤ã™ã‚‹() {
        self.é¸æŠä¸­ã®é§’ = .ãªã—
    }
    func å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã™ã‚‹() {
        self.è¡¨ç¤ºä¸­ã®ã‚·ãƒ¼ãƒˆ = nil
        self.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ä¸­ = true
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
    }
    func å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã™ã‚‹() {
        self.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ä¸­ = false
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
    }
    func å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’ä¸€å€‹å¢—ã‚„ã™(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡) {
        guard self.å±€é¢.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’å¢—ã‚„ã™ã“ã¨ãŒå‡ºæ¥ã‚‹(é™£å–¶, è·å) else { return }
        self.å±€é¢.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’ä¸€å€‹å¢—ã‚„ã™(é™£å–¶, è·å)
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
    }
    func å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’ä¸€å€‹æ¸›ã‚‰ã™(_ é™£å–¶: ç‹å´ã‹ç‰å´ã‹, _ è·å: é§’ã®ç¨®é¡) {
        guard self.å±€é¢.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒå‡ºæ¥ã‚‹(é™£å–¶, è·å) else { return }
        self.å±€é¢.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®æ‰‹é§’ã‚’ä¸€å€‹æ¸›ã‚‰ã™(é™£å–¶, è·å)
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
    }
    func ä¸€æ‰‹æˆ»ã™() {
        guard let ä¸€æ‰‹å‰ã®å±€é¢ = self.å±€é¢.ä¸€æ‰‹å‰ã®å±€é¢ else { return }
        self.è¡¨ç¤ºä¸­ã®ã‚·ãƒ¼ãƒˆ = nil
        self.é¸æŠä¸­ã®é§’ = .ãªã—
        self.å±€é¢.ç¾åœ¨ã®å±€é¢ã¨ã—ã¦é©ç”¨ã™ã‚‹(ä¸€æ‰‹å‰ã®å±€é¢)
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
    }
    // ==== private ====
    private func ç›¤ä¸Šã«é§’ã‚’ç§»å‹•ã•ã›ã‚‹(_ ç§»å‹•å…ˆ: é§’ã®ç§»å‹•å…ˆãƒ‘ã‚¿ãƒ¼ãƒ³) {
        withAnimation(.default.speed(2)) {
            do {
                try self.å±€é¢.é§’ã‚’ç§»å‹•ã•ã›ã‚‹(self.é¸æŠä¸­ã®é§’, ç§»å‹•å…ˆ)
                self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
                self.é§’ç§»å‹•å¾Œã®æˆé§’ã«ã¤ã„ã¦å¯¾å¿œã™ã‚‹(self.é¸æŠä¸­ã®é§’, ç§»å‹•å…ˆ)
                self.é¸æŠä¸­ã®é§’ = .ãªã—
                ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.å¼·ã‚()
            } catch {
                assertionFailure()
            }
        }
    }
    private func é§’ç§»å‹•å¾Œã®æˆé§’ã«ã¤ã„ã¦å¯¾å¿œã™ã‚‹(_ å‡ºç™ºå ´æ‰€: é§’ã®å ´æ‰€, _ ç½®ã„ãŸå ´æ‰€: é§’ã®ç§»å‹•å…ˆãƒ‘ã‚¿ãƒ¼ãƒ³) {
        if case .ç›¤ä¸Š(let ä½ç½®) = ç½®ã„ãŸå ´æ‰€ {
            if self.å±€é¢.ã“ã®é§’ç§»å‹•ã§æˆã‚‹äº‹ãŒå¯èƒ½(.ç›¤é§’(ä½ç½®), å‡ºç™ºå ´æ‰€) {
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.25) {
                    self.æˆé§’ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º = true
                }
            }
        }
    }
    private func ã“ã®é§’ã‚’è£è¿”ã™(_ ä½ç½®: Int) {
        if self.å±€é¢.ã“ã®é§’ã¯æˆã‚‹äº‹ãŒã§ãã‚‹(ä½ç½®) {
            self.å±€é¢.ã“ã®é§’ã‚’è£è¿”ã™(ä½ç½®)
            self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
            ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.å¼·ã‚()
        }
    }
    private func å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®ç›¤é§’ã‚’æ¶ˆã™(_ å ´æ‰€: é§’ã®å ´æ‰€) {
        guard case .ç›¤é§’(let ä½ç½®) = å ´æ‰€ else { return }
        withAnimation(.default.speed(2)) {
            self.å±€é¢.å¢—æ¸›ãƒ¢ãƒ¼ãƒ‰ã§ã“ã®ç›¤é§’ã‚’æ¶ˆã™(ä½ç½®)
        }
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
    }
}

//MARK: - ==== å±€é¢ã®èª­ã¿è¾¼ã¿ã‚„å¾©å…ƒ ====
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    private static func èµ·å‹•æ™‚ã®å±€é¢ã‚’èª­ã¿è¾¼ã‚€() -> å±€é¢ãƒ¢ãƒ‡ãƒ« {
#if os(iOS)
        if ãƒ‡ãƒ¼ã‚¿ç§»è¡Œver_1_3.ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ {
            let å‰å›ã®å±€é¢ = ãƒ‡ãƒ¼ã‚¿ç§»è¡Œver_1_3.ãƒ­ãƒ¼ã‚«ãƒ«ã®ç›´è¿‘ã®å±€é¢ã‚’èª­ã¿è¾¼ã‚€()
            å‰å›ã®å±€é¢.ver_1_3_ã®å±€é¢ã‚’å±¥æ­´ã«è¿½åŠ ã™ã‚‹()
            ãƒ‡ãƒ¼ã‚¿ç§»è¡Œver_1_3.ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹()
            return å‰å›ã®å±€é¢
        } else {
            return å±€é¢ãƒ¢ãƒ‡ãƒ«.å‰å›ã®å±€é¢ ?? .åˆæœŸã‚»ãƒƒãƒˆ
        }
#else
        å±€é¢ãƒ¢ãƒ‡ãƒ«.å‰å›ã®å±€é¢ ?? .åˆæœŸã‚»ãƒƒãƒˆ
#endif
    }
    func ä»»æ„ã®å±€é¢ã‚’ç¾åœ¨ã®å±€é¢ã¨ã—ã¦é©ç”¨ã™ã‚‹(_ å±€é¢: å±€é¢ãƒ¢ãƒ‡ãƒ«) { //å±¥æ­´, ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
        self.è¡¨ç¤ºä¸­ã®ã‚·ãƒ¼ãƒˆ = nil
        withAnimation { self.å±€é¢.ç¾åœ¨ã®å±€é¢ã¨ã—ã¦é©ç”¨ã™ã‚‹(å±€é¢) }
        self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
    }
    func ç¾åœ¨ã®å±€é¢ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã™ã‚‹() {
        self.å±€é¢.ç¾åœ¨ã®å±€é¢ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
    }
    @objc @MainActor
    func iCloudã«ã‚ˆã‚‹å¤–éƒ¨ã‹ã‚‰ã®å±¥æ­´å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹(_ notification: Notification) {
        guard ICloudãƒ‡ãƒ¼ã‚¿.ã“ã®ã‚­ãƒ¼ãŒå¤‰æ›´ã•ã‚ŒãŸ(key: "å±¥æ­´", notification) else { return }
        Task { @MainActor in
            guard let å¤–éƒ¨ã§å¤‰æ›´ã•ã‚ŒãŸå±€é¢ã®æœ€æ–° = å±€é¢ãƒ¢ãƒ‡ãƒ«.å±¥æ­´.last else { return }
            self.å±€é¢ = å¤–éƒ¨ã§å¤‰æ›´ã•ã‚ŒãŸå±€é¢ã®æœ€æ–°
            self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
            self.é§’ã®é¸æŠã‚’è§£é™¤ã™ã‚‹()
        }
    }
}

#if os(iOS) //ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—, SharePlay, ãƒ†ã‚­ã‚¹ãƒˆæ›¸ãå‡ºã—èª­ã¿è¾¼ã¿æ©Ÿèƒ½
//MARK: - ==== ãƒ‰ãƒ©ãƒƒã‚°é–¢é€£ ====
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    func ã“ã®é§’ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—å§‹ã‚ã‚‹(_ å ´æ‰€: é§’ã®å ´æ‰€) -> NSItemProvider {
        self.é¸æŠä¸­ã®é§’ = .ãªã—
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.è»½ã‚()
        self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ = .ã‚¢ãƒ—ãƒªå†…ã®é§’(å ´æ‰€)
        return self.ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ã¨ãªã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”¨æ„ã™ã‚‹()
    }
    private func ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ã¨ãªã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”¨æ„ã™ã‚‹() -> NSItemProvider {
        let ãƒ†ã‚­ã‚¹ãƒˆ = self.ç¾åœ¨ã®ç›¤é¢ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹()
        let itemProvider = NSItemProvider(object: ãƒ†ã‚­ã‚¹ãƒˆ as NSItemProviderWriting)
        itemProvider.suggestedName = "ã‚¢ãƒ—ãƒªå†…ã§ã®ã‚³ãƒç§»å‹•"
        return itemProvider
    }
}

//MARK: - ==== ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ ====
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    func ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹(_ ç½®ã„ãŸå ´æ‰€: é§’ã®ç§»å‹•å…ˆãƒ‘ã‚¿ãƒ¼ãƒ³, _ dropInfo: DropInfo) -> Bool {
        do {
            switch self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ {
                case .ã‚¢ãƒ—ãƒªå†…ã®é§’(let å‡ºç™ºå ´æ‰€):
                    try self.å±€é¢.é§’ã‚’ç§»å‹•ã•ã›ã‚‹(å‡ºç™ºå ´æ‰€, ç½®ã„ãŸå ´æ‰€)
                    self.é§’ç§»å‹•å¾Œã®æˆé§’ã«ã¤ã„ã¦å¯¾å¿œã™ã‚‹(å‡ºç™ºå ´æ‰€, ç½®ã„ãŸå ´æ‰€)
                    self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ = .ç„¡ã—
                    self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
                    ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.å¼·ã‚()
                case .ã‚¢ãƒ—ãƒªå¤–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„:
                    let itemProviders = dropInfo.itemProviders(for: [.utf8PlainText])
                    self.ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç›¤é¢ã«åæ˜ ã™ã‚‹(itemProviders)
                case .ç„¡ã—:
                    return false
            }
            return true
        } catch å±€é¢ãƒ¢ãƒ‡ãƒ«.é§’ç§»å‹•ã‚¨ãƒ©ãƒ¼.ç„¡åŠ¹ {
            return false
        } catch {
            print("ğŸš¨", error.localizedDescription)
            assertionFailure()
            return false
        }
    }
    func ã“ã“ã¯ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ã‹ç¢ºèªã™ã‚‹(_ ç§»å‹•å…ˆ: é§’ã®ç§»å‹•å…ˆãƒ‘ã‚¿ãƒ¼ãƒ³) -> DropProposal? {
        guard case .ã‚¢ãƒ—ãƒªå†…ã®é§’(let ãƒ‰ãƒ©ãƒƒã‚°ã—å§‹ã‚ãŸå ´æ‰€) = self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ else { return nil }
        if self.å±€é¢.ã“ã“ã‹ã‚‰ã“ã“ã¸ã¯ç§»å‹•ä¸å¯(ãƒ‰ãƒ©ãƒƒã‚°ã—å§‹ã‚ãŸå ´æ‰€, ç§»å‹•å…ˆ) {
            return DropProposal(operation: .cancel)
        } else {
            return nil
        }
    }
    func æœ‰åŠ¹ãªãƒ‰ãƒ­ãƒƒãƒ—ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹(_ dropInfo: DropInfo) -> Bool {
        let itemProviders = dropInfo.itemProviders(for: [.utf8PlainText])
        guard let itemProvider = itemProviders.first else { return false }
#if targetEnvironment(macCatalyst)
        if !MacCatalystèª¿æ•´.ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚¢ãƒ—ãƒªå†…ã§ã®ãƒ‰ãƒ©ãƒƒã‚°(â“˜temProvider) {
            self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ = .ã‚¢ãƒ—ãƒªå¤–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        }
        return true
#else
        if let suggestedName = itemProvider.suggestedName {
            if suggestedName != "ã‚¢ãƒ—ãƒªå†…ã§ã®ã‚³ãƒç§»å‹•" {
                self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ = .ã‚¢ãƒ—ãƒªå¤–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            }
        } else {
            self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ = .ã‚¢ãƒ—ãƒªå¤–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        }
        return true
#endif
    }
}

//MARK: - ==== SharePlay ====
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    func æ–°è¦GroupSessionã‚’å—ä¿¡ã—ãŸã‚‰è¨­å®šã™ã‚‹() async {
        for await æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ in ğŸ„¶roupActivity.sessions() {
            self.é§’ã®é¸æŠã‚’è§£é™¤ã™ã‚‹()
            self.å±€é¢.ä½•ã‚‚ç„¡ã„çŠ¶æ…‹ã«å¤‰æ›´ã™ã‚‹()
            self.ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³ = æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³
            let æ–°è¦ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ = GroupSessionMessenger(session: æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³)
            self.ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ = æ–°è¦ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼
            æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³.$state
                .sink {
                    if case .invalidated = $0 {
                        self.ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³ = nil
                        self.ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹()
                    }
                }
                .store(in: &self.ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚º)
            æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³.$activeParticipants
                .sink { activeParticipants in
                    self.å‚åŠ äººæ•° = activeParticipants.count
                    if activeParticipants.count == 1, self.å±€é¢.é§’ãŒ1ã¤ã‚‚ç„¡ã„ {
                        self.å±€é¢.ç¾åœ¨ã®å±€é¢ã¨ã—ã¦é©ç”¨ã™ã‚‹(.åˆæœŸã‚»ãƒƒãƒˆ)
                    }
                    guard self.å±€é¢.SharePlayå…±æœ‰å¯èƒ½ else { return }
                    let æ–°è¦å‚åŠ è€…é” = activeParticipants.subtracting(æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³.activeParticipants)
                    Task {
                        try? await æ–°è¦ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼.send(self.å±€é¢, to: .only(æ–°è¦å‚åŠ è€…é”))
                    }
                }
                .store(in: &self.ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚º)
            let ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Šã‚¿ã‚¹ã‚¯ = Task {
                for await (å—ã‘å–ã£ãŸå±€é¢, _) in æ–°è¦ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼.messages(of: å±€é¢ãƒ¢ãƒ‡ãƒ«.self) {
                    guard self.å±€é¢ != å—ã‘å–ã£ãŸå±€é¢ else { continue }
                    self.SharePlayä¸­ã«å…±æœ‰ç›¸æ‰‹ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’é©ç”¨ã™ã‚‹(å—ã‘å–ã£ãŸå±€é¢)
                }
            }
            self.ã‚¿ã‚¹ã‚¯ã‚¹.insert(ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Šã‚¿ã‚¹ã‚¯)
            æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³.join()
        }
    }
    private func SharePlayä¸­ã«å…±æœ‰ç›¸æ‰‹ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’é©ç”¨ã™ã‚‹(_ æ–°è¦å±€é¢: å±€é¢ãƒ¢ãƒ‡ãƒ«) {
        withAnimation(.default.speed(2.5)) {
            self.å±€é¢.æ›´æ–°æ—¥æ™‚ã‚’å¤‰æ›´ã›ãšã«ãƒ¢ãƒ‡ãƒ«ã‚’é©ç”¨ã™ã‚‹(æ–°è¦å±€é¢)
        }
        self.é§’ã®é¸æŠã‚’è§£é™¤ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.å¼·ã‚()
    }
    private func ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹() {
        self.ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ = nil
        self.ã‚¿ã‚¹ã‚¯ã‚¹.forEach { $0.cancel() }
        self.ã‚¿ã‚¹ã‚¯ã‚¹ = []
        self.ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚º = []
        self.å‚åŠ äººæ•° = nil
        if self.ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³ != nil {
            self.ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³?.leave()
            self.ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³ = nil
            ğŸ„¶roupActivity.ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èµ·å‹•ã™ã‚‹()
        }
    }
    private func SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹() {
        if let ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ {
            guard self.å±€é¢.SharePlayå…±æœ‰å¯èƒ½ else { assertionFailure(); return }
            Task {
                do {
                    try await ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼.send(self.å±€é¢)
                } catch {
                    print("ğŸš¨", #function, #line, error.localizedDescription)
                }
            }
        }
    }
    var ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆè¡¨è¨˜: LocalizedStringKey {
        switch self.ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒƒã‚·ãƒ§ãƒ³?.state {
            case .waiting: "å¾…æ©Ÿä¸­"
            case .joined: "å‚åŠ ä¸­"
            case .invalidated(_): "ç„¡åŠ¹"
            case .none: "ãªã—"
            @unknown default: "!æƒ³å®šå¤–!"
        }
    }
    //Sample code
    //https://developer.apple.com/documentation/groupactivities/drawing_content_in_a_group_session
}

//MARK: - ==== ãƒ†ã‚­ã‚¹ãƒˆæ›¸ãå‡ºã—èª­ã¿è¾¼ã¿æ©Ÿèƒ½ ====
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    func ç¾åœ¨ã®ç›¤é¢ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹() -> String {
        ãƒ†ã‚­ã‚¹ãƒˆé€£æºæ©Ÿèƒ½.ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹(self.å±€é¢)
    }
    private func ãƒ†ã‚­ã‚¹ãƒˆã‚’å±€é¢ã«å¤‰æ›ã—ã¦èª­ã¿è¾¼ã‚€(_ ãƒ†ã‚­ã‚¹ãƒˆ: String) {
        if let ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå±€é¢ = ãƒ†ã‚­ã‚¹ãƒˆé€£æºæ©Ÿèƒ½.å±€é¢ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ã™ã‚‹(ãƒ†ã‚­ã‚¹ãƒˆ) {
            self.å±€é¢.ç¾åœ¨ã®å±€é¢ã¨ã—ã¦é©ç”¨ã™ã‚‹(ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå±€é¢)
            self.SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹()
            ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
        }
    }
    func ç¾åœ¨ã®å±€é¢ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã‚³ãƒ”ãƒ¼() {
        UIPasteboard.general.string = self.ç¾åœ¨ã®ç›¤é¢ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹()
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯.æˆåŠŸ()
    }
    func ãƒ†ã‚­ã‚¹ãƒˆã‚’å±€é¢ã¨ã—ã¦ãƒšãƒ¼ã‚¹ãƒˆ() {
        guard let ãƒ†ã‚­ã‚¹ãƒˆ = UIPasteboard.general.string else { return }
        self.ãƒ†ã‚­ã‚¹ãƒˆã‚’å±€é¢ã«å¤‰æ›ã—ã¦èª­ã¿è¾¼ã‚€(ãƒ†ã‚­ã‚¹ãƒˆ)
    }
    private func ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç›¤é¢ã«åæ˜ ã™ã‚‹(_ itemProviders: [NSItemProvider]) {
        Task { @MainActor in
            do {
                guard let itemProvider = itemProviders.first else { return }
                let secureCodingObject = try await itemProvider.loadItem(forTypeIdentifier: UTType.utf8PlainText.identifier)
                guard let ãƒ‡ãƒ¼ã‚¿ = secureCodingObject as? Data else { return }
                guard let ãƒ†ã‚­ã‚¹ãƒˆ = String(data: ãƒ‡ãƒ¼ã‚¿, encoding: .utf8) else { return }
                self.ãƒ†ã‚­ã‚¹ãƒˆã‚’å±€é¢ã«å¤‰æ›ã—ã¦èª­ã¿è¾¼ã‚€(ãƒ†ã‚­ã‚¹ãƒˆ)
                self.ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é§’ = .ç„¡ã—
            } catch {
                print(#function, error)
            }
        }
    }
}
#endif

#if os(watchOS) || os(tvOS)
extension ã‚¢ãƒ—ãƒªãƒ¢ãƒ‡ãƒ« {
    private func SharePlayä¸­ãªã‚‰ç¾åœ¨ã®å±€é¢ã‚’å‚åŠ è€…ã«é€ä¿¡ã™ã‚‹() {
        //Unsupport on watchOS, tvOS
    }
}
#endif
